# CMakeLists.txt for ConnectServer Phase 1 (No Boost Required)
cmake_minimum_required(VERSION 3.15)
project(ConnectServer VERSION 1.0.0 LANGUAGES CXX)

# C++ Standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Platform detection
if(WIN32)
    set(PLATFORM_WINDOWS TRUE)
    add_compile_definitions(PLATFORM_WINDOWS)
elseif(UNIX AND NOT APPLE)
    set(PLATFORM_LINUX TRUE)
    add_compile_definitions(PLATFORM_LINUX)
endif()

# Build type
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()

message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Platform: ${CMAKE_SYSTEM_NAME}")

# Find dependencies (only Threads for Phase 1)
find_package(Threads REQUIRED)

# Source files (Phase 1 - Foundation)
set(SOURCES
    src/main.cpp
    src/ConfigManager.cpp
    src/CriticalSection.cpp
    src/Queue.cpp
    src/Console.cpp
    src/ConsoleInterface.cpp
    src/Util.cpp
)

set(HEADERS
    include/ConfigManager.h
    include/CriticalSection.h
    include/Queue.h
    include/Console.h
    include/ConsoleInterface.h
    include/Util.h
    include/ProtocolDefines.h
)

# Platform-specific sources
if(PLATFORM_WINDOWS)
    list(APPEND SOURCES src/platform/windows/CrashHandler.cpp)
    list(APPEND HEADERS include/platform/windows/CrashHandler.h)
elseif(PLATFORM_LINUX)
    list(APPEND SOURCES src/platform/linux/SignalHandler.cpp)
    list(APPEND HEADERS include/platform/linux/SignalHandler.h)
endif()

# Executable
add_executable(ConnectServer ${SOURCES} ${HEADERS})

# Include directories
target_include_directories(ConnectServer
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/include
)

# Link libraries
target_link_libraries(ConnectServer
    PRIVATE
        Threads::Threads
)

# Platform-specific libraries
if(PLATFORM_WINDOWS)
    target_link_libraries(ConnectServer PRIVATE ws2_32 dbghelp)
elseif(PLATFORM_LINUX)
    target_link_libraries(ConnectServer PRIVATE dl)
endif()

# Compiler flags
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    target_compile_options(ConnectServer PRIVATE
        -Wall
        -Wextra
        -Wpedantic
        -Wno-unused-parameter
        $<$<CONFIG:Release>:-O3>
        $<$<CONFIG:Debug>:-g -O0>
    )
    
elseif(MSVC)
    target_compile_options(ConnectServer PRIVATE
        /W4
        /permissive-
        $<$<CONFIG:Release>:/O2>
        $<$<CONFIG:Debug>:/Od /Zi>
    )
    
    # Enable multi-processor compilation
    target_compile_options(ConnectServer PRIVATE /MP)
endif()

# Print configuration summary
message(STATUS "")
message(STATUS "Configuration Summary (Phase 1):")
message(STATUS "  Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "  C++ compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "  C++ standard: C++${CMAKE_CXX_STANDARD}")
message(STATUS "  Platform: ${CMAKE_SYSTEM_NAME}")
message(STATUS "  Note: This is Phase 1 build (Boost not required)")
message(STATUS "")
